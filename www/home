<?php

include_once "session-start.php";
include_once "dbconnect.php";
include_once "util.php";
include "pagetpl.php";
include_once "login-persist.php";
include "newitems.php";
include_once "commentutil.php";

$db = dbConnect();

$uid = checkPersistentLogin();
$quid = mysql_real_escape_string($uid, $db);

$loggedIn = (isset($_SESSION['logged_in']) && $_SESSION['logged_in']);


$adminPriv = false;
$caughtUpDate = false;
if ($uid) {
    $result = mysql_query(
        "select `privileges`, caughtupdate from users where id='$quid'", $db);
    $priv = mysql_result($result, 0, "privileges");
    $adminPriv = (strpos($priv, "A") !== false);
    $caughtUpDate = mysql_result($result, 0, "caughtupdate");
}

$debugflag = $adminPriv && get_req_data('debug') == 'yesDebug';
if ($debugflag) echo "debug mode enabled...<br>";

pageHeader("The Interactive Fiction Database - IF and Text Adventures");

?>

<div style="width:100%;">
<table style="width:100%;" cellpadding=0 cellspacing=0 border=0>
   <tr>


      <?php
// -------------------------- left column ---------------------------------
// (currently empty)
      ?>
      <td valign=top>


      </td>
      <?php
// ------------------------- center column --------------------------------
      ?>
      <td valign=top>

         <div class="headline headline1">
            Welcome to IFDB!
            <span class=headlineRss>
               <a href="news">Site News</a> |
               <a href="news?rss">
                  <img src="blank.gif" class="rss-icon">RSS Feed</a>
            </span>
         </div>

         <p>The Interactive Fiction Database is an IF game catalog and
         recommendation engine.  IFDB is a Wiki-style
         community project: members can add new game listings, write
         reviews, exchange game recommendations, and more.
         <span class=details><a href="tips">Tips &amp; More Info</a></span>

         <?php include "components/check-inbox.php"?>

         <div class=headline>
            New on IFDB
            <span class=headlineRss>
               <a href="allnew-rss">
                  <img src="blank.gif" class="rss-icon">RSS Feed</a>
            </span>
         </div>

            <?php
//         <div class=indented>

if (!$db) {
    echo "<span class=errmsg>An error occurred connecting to the
        database. Please try again later, or <a href=\"contact\">contact
        us</a> if the problem persists.</span>";
}
else {
    $limit = 5;
    
    // get the latest games, reviews, and lists, and show a mix
    if (showNewItems($db, 0, 5, false, false, false))
        echo "<p><span class=details><a href=\"allnew\">"
            . "See the full list...</a></span></p>";
}

//         </div>
            ?>


      <?php
// ----------------------- bottom extra stuff table ----------------------
      ?>

      </div>
      <div class=twocol>
         <?php include "components/poll-sampler.php"?>


            <?php
// ------------------------ New To IF? box ------------------------------
            ?>


            <div width="<?php echo $colWidth ?>">
               <table class="halfcol" cellpadding=0 cellspacing=0>
                  <tr>
                     <td class="<?php echo $colClass; $colClass=""; ?>">
                        <div class="headline">
                           New to IF?
                        </div>
                        The IFDB <b>Download Adviser</b> can help get you up and
                        running with the games you find on IFDB.  Just click
                        <img src="dlhelpbtn.gif" align="absmiddle"
                             alt='The "Show me how!" button'>
                        in any game's Download box for customized, step-by-step
                        instructions for running the game on your system.
                     </td>
                  </tr>
               </table>
            </div>
      </div>
            <?php
// ----------------------- End New To IF? Box ---------------------------
            ?>
         
      </div>
      <?php
// ------------------------- end bottom row extra stuff table ----------------
      ?>

<?php include "components/ifdb-recommends.php"?>

      </td>

      <?php
// -------------------------- right column ------------------------------
      ?>
      <td align=right valign=top>



         <?php
            // ----------------- control panel ---------------------
         ?>
         <table class="rightbar cpanel" cellpadding="0" cellspacing="0"
                   id="HomeControlPanel">
            <tr>
               <td>

<script type="text/javascript">
<!--
function cpanelMouseOver(e, div)
{
    div.className += " cpanelBtnHover";
}
function cpanelMouseOut(e, div)
{
    div.className = div.className.replace(/ [a-zA-Z]+$/, "");
}
//-->
</script>

<?php
function cpbtn($icon, $label, $href, $top)
{
    echo "<div class=\"cpanelBtn" . ($top ? " cpanelBtnTop" : "")
        . "\" onmouseover=\"javascript:cpanelMouseOver(event, this);\" "
        . "onmouseout=\"javascript:cpanelMouseOut(event, this);\" "
        . "onclick=\"javascript:window.navigate('$href');return false;\">"
        . "<a href=\"$href\">"
        . "<img src=\"/blank.gif\" class=\"$icon cpanelBtnIcon\"></a> "
        . "<a href=\"$href\">$label</a>"
        . "</div>";
}
?>
                  <div class="cpanelHeading cpanelHeadingTop">Find</div>
                  <?php cpbtn("game-search-icon", "Advanced Game Search",
                              "search", true) ?>
                  <?php cpbtn("list-search-icon", "Find a Recommended List",
                              "search?list", false) ?>
                  <?php cpbtn("poll-search-icon", "Find a Poll",
                              "search?poll", false) ?>
                  <?php cpbtn("new-poll-icon", "Create a Poll",
                              "poll?id=new", false) ?>
                  <?php cpbtn("competition-search-icon","Find a Competition",
                              "search?comp", false) ?>
                  <?php cpbtn("club-search-icon","Find a Club",
                              "search?club", false) ?>
                  <?php cpbtn("member-search-icon", "Look Up a Member",
                              "search?member", false) ?>

                  <div class="cpanelHeading">Browse</div>
                  <?php cpbtn("random-list-icon", "10 Random Games",
                              "random", true) ?>
                  <?php cpbtn("browse-games-icon", "Browse Games",
                              "search?browse", false) ?>
                  <?php cpbtn("browse-lists-icon", "Browse Lists",
                              "search?browse&list&sortby=new", false) ?>
                  <?php cpbtn("browse-polls-icon", "Browse Polls",
                              "search?browse&poll&sortby=new", false) ?>
                  <?php cpbtn("browse-competitions-icon", "Browse Competitions",
                              "search?browse&comp&sortby=awn", false) ?>
                  <?php cpbtn("browse-clubs-icon", "Browse Clubs",
                              "search?browse&club&sortby=new", false) ?>
                  <?php cpbtn("browse-members-icon", "Browse Members",
                              "search?browse&member&sortby=new", false) ?>

                  <div class="cpanelHeading">Contribute</div>
                  <?php cpbtn("create-review-icon", "Review a Game",
                              "review?browse", true) ?>
                  <?php cpbtn("create-list-icon", "Create a Recommended List",
                              "editlist?id=new", false) ?>
                  <?php cpbtn("create-game-icon", "Add a Game Listing",
                              "editgame?id=new", false) ?>
                  <?php cpbtn("edit-game-icon", "Edit a Game Listing",
                              "editgame?search", false) ?>
                  <?php cpbtn("create-competition-icon", "Add a Competition Page",
                              "editcomp?id=new", false) ?>
                  <?php cpbtn("create-club-icon", "Add a Club Listing",
                              "editclub?id=new", false) ?>

                  <div class="cpanelHeading">Personalize</div>
                  <?php cpbtn("my-profile-icon", "Edit Your Profile",
                              "editprofile", true) ?>
                  <?php cpbtn("style-gallery-icon", "Pick a Custom Display Style",
                              "styles", true) ?>

                  <?php
                  if ($adminPriv) {
                      echo "<div class='cpanelHeading'>Administration</div>";
                      cpbtn("empty-button-icon", "System Maintenance Panel",
                            "adminops", true);
                  }
                  ?>

               </td>
            </tr>
         </table>


<?php
   // ------------------------ top reviewers insert --------------------
    ?>


         <table class=rightbar cellpadding=0 cellspacing=0>
            <tr class="boxhead">
               <td><h3>Reviewer Trophy Room</h3></td>
            </tr>
            <tr>
               <td>
                  <span class=details><i>IFDB's top reviewers, as determined
                     by <?php echo helpWinLink("help-ff", "Frequent Fiction")
                     ?> scores:</i></span><p>
                  <?php

$rlst = getTopReviewers($db, 4);
$n = 1;
foreach ($rlst as $r) {
    list($ruid, $runame, $rscore) = $r;
    $runame = htmlspecialcharx($runame);
    echo "<span style='padding: 0 1.5ex 0 1ex;' class=details><i>#$n</i></span>"
        . "<a class=silent href=\"showuser?id=$ruid\">$runame</a>"
        . "<br>";
    $n++;
}

                  ?>

                  <p><span class=details>
                     <a href="search?sortby=ffrank&browse=1&member=1">
                     See all</a> |
                  <?php echo helpWinLink(
                      "help-top-rev", "Who qualifies?") ?>
                  </span>
    
               </td>
            </tr>
         </table>

<?php
// -------------------- end reviewers insert ------------------------------
?>


         <?php
//  ----------------------- Join IFDB ad --------------------------------

if (!$loggedIn) {
         ?>
         <p>
         <table class=rightbar cellpadding=0 cellspacing=0>
            <tr class="boxhead">
               <td align=center><h3>Join IFDB!</h3></td>
            </tr>
            <tr>
               <td>
                  IFDB isn't just for reading about IF - you can also
                  share your opinions about your favorite games.
                  Members can write reviews, create Recommended Lists,
                  add and edit game listings, and more. Membership
                  is free and only takes a few moments to set up.
                  <a href="newuser">Sign up now!</a>
               </td>
            </tr>
         </table>
         <?php
}
//  ----------------------- End Join IFDB ad -----------------------------
         ?>



<?php
   //------------------------- statistics insert --------------------
?>

        <table class="rightbar" cellpadding="0" cellspacing="0">
            <tr>
               <td>
                  <h3>In the Database</h3>
<?php
   
$result = mysql_query("select count(*) as c from games", $db);
$cnt = mysql_result($result, 0, "c");
echo "&bull; <a class=silent href=\"search?browse\">$cnt Game Listings</a><br>";

$result = mysql_query(
    "select count(*) as c from reviews
     where special is null
       and review is not null
       and ifnull(now() >= embargodate, 1)", $db);
$cnt = mysql_result($result, 0, "c");
if ($cnt)
    echo "&bull; $cnt Member Reviews<br>";

$result = mysql_query(
    "select count(*) as c from reviews
     where
       rating is not null
       and special is null
       and review is null
       and ifnull(now() >= embargodate, 1)", $db);
$cnt2 = mysql_result($result, 0, "c");
if ($cnt2)
    echo "&bull; $cnt2 Member Ratings<br>";

$result = mysql_query(
    "select count(*) as c from users
     where acctstatus = 'A' and ifnull(profilestatus, ' ') != 'R' ", $db);
$cnt = mysql_result($result, 0, "c");
if ($cnt)
    echo "&bull; <a class=silent href=\"search?browse&member&sortby=new\">"
        . "$cnt Registered Members</a><br>";

$result = mysql_query("select count(*) as c from reclists", $db);
$cnt = mysql_result($result, 0, "c");
if ($cnt)
    echo "&bull; <a class=silent href=\"search?browse&list&sortby=new\">"
        . "$cnt Recommended Lists</a><br>";

$result = mysql_query("select count(*) as c from polls", $db);
$cnt = mysql_result($result, 0, "c");
if ($cnt)
    echo "&bull; <a class=silent href=\"search?browse&poll&sortby=new\">"
        . "$cnt Polls</a><br>";
    
$result = mysql_query("select count(*) as c from competitions", $db);
$cnt = mysql_result($result, 0, "c");
if ($cnt)
    echo "&bull; <a class=silent href=\"search?browse&comp\">"
        . "$cnt Competition Listings</a><br>";
    
echo "</div>";
?>

               </td>
            </tr>
         </table>

<?php
// ---------------------- end statistics insert ----------------------
?>
            


<?php
//         <p>
//         <table class=rightbar cellpadding=0 cellspacing=0>
//            <tr class="boxhead">
//               <td><h3>Customize IFDB</h3></td>
//            </tr>
//            <tr>
//               <td>
//                  You can change the way IFDB looks by choosing a new
//                  layout from the <a href="styles?gallery">style gallery</a>,
//                  and you can even create your own custom style from
//                  scratch. <a href="styles">Learn more...</a>
//               </td>
//            </tr>
//         </table>
?>

<?php
//         <p>
//         <table class=rightbar cellpadding=0 cellspacing=0>
//            <tr class="boxhead">
//               <td><h3>What is IFDB?</h3></td>
//            </tr>
//            <tr>
//               <td>
//                  It's a game catalog and recommendation engine for
//                  Interactive Fiction.  If you're looking for a new game
//                  to play, we have the tools to help you find something
//                  you'll like.  If you're a veteran adventurer, use IFDB
//                  to promote your favorite games.
//                  <a href="tips">Tips &amp; More Info</a>
//                  - <a href="news">Site News</a>
//               </td>
//            </tr>
//         </table>
?>


<?php
   // ------------------------ OLD "IN THE DATABASE" SECTION -----------------
//
//         <p>
//         <table class=rightbar cellpadding=0 cellspacing=0>
//            <tr class="boxhead">
//               <td><h3>In the Database</h3></td>
//            </tr>
//            <tr>
//               <td>
//
//                  < ?php
//
//$result = mysql_query("select count(*) as c from games", $db);
//$cnt = mysql_result($result, 0, "c");
//echo "&bull; <a class=silent href=\"search?browse\">$cnt Game Listings</a><br>";
//
//$result = mysql_query(
//    "select count(*) as c from reviews
//     where special is null
//       and review is not null
//       and ifnull(now() >= embargodate, 1)", $db);
//$cnt = mysql_result($result, 0, "c");
//if ($cnt)
//    echo "&bull; $cnt Member Reviews<br>";
//
//$result = mysql_query(
//    "select count(*) as c from reviews
//     where
//       rating is not null
//       and special is null
//       and review is null
//       and ifnull(now() >= embargodate, 1)", $db);
//$cnt2 = mysql_result($result, 0, "c");
//if ($cnt2)
//    echo "&bull; $cnt2 Member Ratings<br>";
//
//$result = mysql_query("select count(*) as c from users", $db);
//$cnt = mysql_result($result, 0, "c");
//if ($cnt)
//    echo "&bull; <a class=silent href=\"search?browse&member&sortby=new\">"
//        . "$cnt Registered Members</a><br>";
//
//$result = mysql_query("select count(*) as c from reclists", $db);
//$cnt = mysql_result($result, 0, "c");
//if ($cnt)
//    echo "&bull; <a class=silent href=\"search?browse&list&sortby=new\">"
//        . "$cnt Recommended Lists</a><br>";
//
//
//                  ? >
//
//               </td>
//            </tr>
//         </table>

// -------------------- END OLD "IN THE DATABASE" SECTION ------------------
?>

      </td>
   </tr>
</table>


<?php

// ----------------------- OBSOLETE BOTTOM CONTROL PANEL ---------------------
if (false) {
?>


<table class=botbar>
   <tr valign=top>
      <td width="50%">
         <table width="100%" height="100%">
            <tr class=botbarhdr>
               <td>
                  Find Games &amp; Recommendations
               </td>
            </tr>
            <tr>
               <td>
                  <div class=indented>
                     <div>
                        <b><a href="search">
                           <img src="/blank.gif" class="game-search-icon"></a>
                        <a href="search">Advanced game search</a></b>
                     </div>
                     <div>
                        <b><a href="search?list">
                           <img src="/blank.gif" class="list-search-icon"></a>
                        <a href="search?list">Find a Recommended List</a></b>
                     </div>
                     <div>
                        <b><a href="poll?id=new">
                           <img src="/blank.gif" class="new-poll-icon"></a>
                        <a href="poll?id=new">Create a poll</a></b>
                     </div>
                     <div>
                        <b><a href="random">
                           <img src="/blank.gif" class="random-list-icon"></a>
                        <a href="random">10 Random Games</a></b>
                     </div>
                     <div>
                        <b><a href="search?member">
                           <img src="/blank.gif" class="member-search-icon"></a>
                        <a href="search?member">Look up a member</a></b>
                     </div>
                     <div>
                        <b><a href="search?browse">
                           <img src="/blank.gif" class="browse-games-icon"></a>
                        <a href="search?browse">Browse games</a></b>
                     </div>
                     <div>
                        <b><a href="search?browse&list">
                           <img src="/blank.gif" class="browse-lists-icon"></a>
                        <a href="search?browse&list&sortby=new">Browse Recommended Lists</a></b>
                        or
                        <b><a href="search?browse&poll&sortby=new">Polls</a></b>
                     </div>
                     <div>
                        <b><a href="search?browse&member">
                           <img src="/blank.gif" class="browse-members-icon"></a>
                        <a href="search?browse&member">Browse members</a></b>
                     </div>
                  </div>
               </td>
            </tr>
         </table>
      </td>
         
      <td width="50%">
         <table width="100%" height="100%">
            <tr class=botbarhdr>
               <td>
                  Contribute
               </td>
            </tr>
            <tr>
               <td>
                  <div class=indented>
                     <div>
                        <b><a href="personal">
                           <img src="/blank.gif" class="personal-page-icon"></a>
                        <a href="personal">Go to your personal IFDB page</a></b>
                     </div>
                     <div>
                        <b><a href="editlist?id=new">
                           <img src="/blank.gif" class="create-list-icon"></a>
                        <a href="editlist?id=new">Create a Recommended List</a></b>
                     </div>
                     <div>
                        <b><a href="editgame?id=new">
                           <img src="/blank.gif" class="create-game-icon" ></a>
                        <a href="editgame?id=new">Add a new game listing</a></b>
                     </div>
                     <div>
                        <b><a href="editcomp?id=new">
                           <img src="/blank.gif" class="create-competition-icon" ></a>
                        <a href="editcomp?id=new">Add a new competition page</a></b>
                     </div>
                     <div>
                        <img src="/blank.gif" class="edit-game-icon">
                        To <b>Update a game listing</b> - visit the game's listing
                     </div>
                     <div>
                        <img src="/blank.gif" class="create-review-icon">
                        To <b>Review a game</b> - visit the game's listing<br>
                     </div>
                  </div>
               </td>
            </tr>
         </table>
      </td>
   </tr>
</table>

<?php

if ($adminPriv)
echo "<p><a href=\"adminops\">Administrative Operations</a><p>";
}
// ------------------ END OBSOLETE BOTTOM CONTROL PANEL ---------------------

pageFooter();

?>